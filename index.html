<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LKKB 二維碼生成器</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 設定 Tailwind 配置，使用 Inter 字體 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* 自定義樣式來確保容器寬度在不同設備上都良好 */
        #qrcode-container {
            display: flex;
            justify-content: center;
            align-items: center;
            /* 恢復到較短的預覽高度，約 300px QR + padding，避免預覽畫面過長 */
            min-height: 350px; 
            padding: 1rem;
            background-color: #f7f7f7;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            /* 預設狀態顯示一個提示，而不是空的白色背景 */
            color: #6b7280;
            font-size: 0.875rem;
        }

        /* 隱藏 qrcode.js 生成的 canvas 邊框（如果它顯示出來） */
        #qrcode-container canvas {
            display: block;
        }

        /* 新增規則：確保生成的 QR 碼 (Canvas/Table) 在容器內響應式縮小，保持預覽畫面長度適中 */
        #qrcode-container canvas, 
        #qrcode-container table {
            max-width: 100%;
            height: auto !important; /* 覆蓋 inline height 屬性，確保等比例縮放 */
        }
    </style>
    <!-- 引入 qrcode.js 函式庫 -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4 font-sans">

    <div class="w-full max-w-lg bg-white p-6 md:p-8 rounded-xl shadow-2xl border border-blue-100">

        <h1 class="text-3xl font-extrabold text-center text-blue-800 mb-6 border-b-2 border-blue-200 pb-2">
            <!-- 標題圖案放大一倍：h-8 w-8 變為 h-16 w-16 -->
            <img src="https://raw.githubusercontent.com/HWLEUNG/LKKB_QRcode/main/Blue.png" 
                 alt="LKKB 品牌圖案" 
                 class="h-16 w-16 inline-block mr-3 align-middle"
                 onerror="this.onerror=null; this.src='https://placehold.co/64x64/1E3A8A/FFFFFF?text=LKKB';" 
            >
            <span class="text-indigo-600">LKKB</span> 二維碼生成器
        </h1>
        
        <!-- 輸入區域 -->
        <div class="mb-4">
            <label for="dataInput" class="block text-sm font-medium text-gray-700 mb-2">要編碼的內容 (文字或網址):</label>
            <input type="text" id="dataInput" placeholder="輸入要編碼的文字或網址..."
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-sm"
                   value=""> <!-- 已移除預設值 -->
        </div>

        <!-- 按鈕區域 -->
        <div class="flex flex-col sm:flex-row gap-3 mb-6">
            <button id="generateBtn" onclick="generateQrCode()"
                    class="w-full sm:w-1/2 flex items-center justify-center px-4 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-200 shadow-md transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                </svg>
                生成二維碼
            </button>

            <button id="downloadBtn" onclick="downloadQrCode()" disabled
                    class="w-full sm:w-1/2 flex items-center justify-center px-4 py-3 bg-green-500 text-white font-semibold rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-green-600 transition duration-200 shadow-md transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1M16 12l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                下載二維碼 (PNG)
            </button>
        </div>

        <!-- 狀態與顯示區域 -->
        <div id="statusMessage" class="text-center text-sm text-gray-500 mb-4 p-2 bg-gray-100 rounded-lg">
            請輸入內容並點擊「生成二維碼」。
        </div>

        <!-- QR 碼顯示區域 -->
        <div id="qrcode-container" class="transition-all duration-300 flex-col space-y-3">
             <!-- 初始顯示圖片和提示文字 -->
             <!-- 預設提示圖案放大一倍：h-20 w-20 變為 h-40 w-40 -->
             <img src="https://raw.githubusercontent.com/HWLEUNG/LKKB_QRcode/main/Blue.png" 
                 alt="LKKB 品牌圖案 - 點擊生成" 
                 class="h-40 w-40 opacity-70"
                 onerror="this.onerror=null; this.src='https://placehold.co/160x160/1E3A8A/FFFFFF?text=LKKB';" 
            >
            <span class="text-base text-gray-500 font-semibold">請輸入內容後，點擊「生成二維碼」。</span>
        </div>
    </div>

    <script>
        // 初始化變數
        let qrCodeInstance = null;
        const qrCodeContainer = document.getElementById('qrcode-container');
        const dataInput = document.getElementById('dataInput');
        const generateBtn = document.getElementById('generateBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const statusMessage = document.getElementById('statusMessage');

        // 定義初始內容的 HTML 結構，用於錯誤或空白輸入時重置顯示區域
        const initialQrPlaceholderHtml = `
            <img src="https://raw.githubusercontent.com/HWLEUNG/LKKB_QRcode/main/Blue.png" 
                 alt="LKKB 品牌圖案 - 點擊生成" 
                 class="h-40 w-40 opacity-70"
                 onerror="this.onerror=null; this.src='https://placehold.co/160x160/1E3A8A/FFFFFF?text=LKKB';" 
            >
            <span class="text-base text-gray-500 font-semibold">請輸入內容後，點擊「生成二維碼」。</span>
        `;

        /**
         * 顯示狀態訊息。
         * @param {string} message - 要顯示的訊息。
         * @param {string} color - Tailwind text color class (e.g., 'text-gray-500', 'text-red-500').
         */
        function setStatus(message, color = 'text-gray-500') {
            statusMessage.textContent = message;
            statusMessage.className = `text-center text-sm ${color} mb-4 p-2 bg-gray-100 rounded-lg`;
        }

        /**
         * 處理生成 QR 碼的邏輯。
         */
        function generateQrCode() {
            const data = dataInput.value.trim();
            downloadBtn.disabled = true;

            // 確保容器在生成 QR 碼前是 flex 居中模式
            qrCodeContainer.classList.remove('flex-col', 'space-y-3');

            if (!data) {
                setStatus('錯誤：請輸入有效的內容。', 'text-red-500 bg-red-100');
                // 清空 QR 碼顯示區，並重新顯示圖片和提示文字
                qrCodeContainer.innerHTML = initialQrPlaceholderHtml;
                qrCodeContainer.classList.add('flex-col', 'space-y-3');
                qrCodeInstance = null;
                return;
            }

            setStatus('正在生成二維碼...', 'text-blue-600 bg-blue-100');

            // 1. 清理舊的 QR 碼
            qrCodeContainer.innerHTML = '';
            
            // 2. 銷毀舊的實例（如果存在）
            if (qrCodeInstance) {
                qrCodeInstance = null;
            }
            
            // 3. 生成新的 QR 碼實例
            try {
                // 設定 QR 碼尺寸為 600x600 (用於高解析度下載)
                const targetSize = 600;

                // 使用 qrcode.js 庫
                qrCodeInstance = new QRCode(qrCodeContainer, {
                    text: data,
                    width: targetSize, 
                    height: targetSize, 
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H // 選擇高容錯率以容納 Logo
                });

                // 由於 qrcode.js 是異步渲染，我們需要等待一下才能插入 Logo
                setTimeout(() => {
                    const canvas = qrCodeContainer.querySelector('canvas');

                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        const img = new Image();
                        // 確保下載功能相容性
                        img.crossOrigin = "Anonymous"; 
                        
                        img.onload = function() {
                            console.log('LKKB Logo 圖像載入成功，正在繪製到 QR 碼上。');
                            const qrSize = targetSize; // 600
                            
                            // 保持 Logo 區域佔約 30% 寬度（H 級容錯率的安全範圍）
                            const totalLogoAreaSize = 180; // 600 * 30%
                            const padding = 5; 
                            const logoSize = totalLogoAreaSize - 2 * padding; // 170x170
                            
                            // 計算置中座標 (600 - 180) / 2 = 210
                            const x = (qrSize - totalLogoAreaSize) / 2;
                            const y = (qrSize - totalLogoAreaSize) / 2;

                            // 1. 繪製白色背景
                            ctx.fillStyle = '#FFFFFF';
                            ctx.fillRect(x, y, totalLogoAreaSize, totalLogoAreaSize);

                            // 2. 繪製 Logo
                            ctx.drawImage(img, x + padding, y + padding, logoSize, logoSize);
                            
                            // 完成後啟用下載並設定狀態
                            downloadBtn.disabled = false;
                            setStatus('二維碼生成成功！下載前請記得測試。', 'text-green-600 bg-green-100');
                        };
                        
                        img.onerror = function() {
                            console.error('錯誤：LKKB Logo 載入失敗或路徑無效。QR 碼將不含 Logo。');
                            // 即使 Logo 載入失敗，QR 碼主體仍可用
                            downloadBtn.disabled = false;
                            setStatus('二維碼生成成功！下載前請記得測試 (Logo載入失敗)。', 'text-orange-500 bg-orange-100');
                        };
                        
                        img.src = 'https://raw.githubusercontent.com/HWLEUNG/LKKB_QRcode/main/Blue.png';
                    } else {
                        console.error("Canvas element not found after QR code generation.");
                        downloadBtn.disabled = false;
                        setStatus('二維碼生成成功！下載前請記得測試。', 'text-green-600 bg-green-100');
                    }
                }, 500); // 增加延遲到 500ms，確保 canvas 渲染完成
                
            } catch (error) {
                console.error("QR Code Generation Error:", error);
                setStatus('生成二維碼時發生錯誤。', 'text-red-500 bg-red-100');
            }
        }

        /**
         * 處理下載 QR 碼為 PNG 檔案的邏輯。
         */
        function downloadQrCode() {
            if (downloadBtn.disabled || !qrCodeInstance) {
                setStatus('無法下載。請先生成二維碼。', 'text-red-500 bg-red-100');
                return;
            }

            setStatus('正在準備下載...', 'text-yellow-600 bg-yellow-100');

            // qrcode.js 會將 QR 碼渲染到 canvas 元素中
            const canvas = qrCodeContainer.querySelector('canvas');

            if (canvas) {
                // 取得 canvas 內容的 Data URL
                const dataURL = canvas.toDataURL('image/png');
                
                // 創建一個虛擬連結 a 元素
                const link = document.createElement('a');
                link.href = dataURL;
                
                const data = dataInput.value.trim();
                let filename = '';
                let cleanedName = '';

                try {
                    let url;
                    try {
                        // 1. 嘗試直接解析 URL (需要協定 e.g., http://)
                        url = new URL(data);
                    } catch (e) {
                        // 2. 如果失敗，嘗試添加 https:// 再解析
                        try {
                            url = new URL('https://' + data);
                        } catch (e2) {
                            // 3. 徹底失敗，不是有效的 URL
                            url = null;
                        }
                    }

                    if (url && url.hostname) {
                        let domain = url.hostname;
                        // 移除 www.
                        domain = domain.replace(/^www\./, '');
                        
                        // 清理 domain name 中的點號，替換為底線
                        cleanedName = domain.replace(/\./g, '_');
                        filename = `LKKB_${cleanedName}.png`;
                    } else {
                        // 拋出錯誤，讓 catch 區塊處理為文本命名
                        throw new Error('Not a recognizable URL.');
                    }

                } catch (e) {
                    // Fallback: 使用文本截斷邏輯
                    const dataText = data.substring(0, 20).replace(/[^a-zA-Z0-9]/g, '_');
                    cleanedName = dataText || 'default';
                    filename = `LKKB_QRCode_${cleanedName}.png`;
                }

                // 設定下載檔名
                link.download = filename;

                // 模擬點擊下載
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                setStatus('二維碼已開始下載。', 'text-green-600 bg-green-100');

            } else {
                // 如果找不到 canvas，可能是因為 qrcode.js 使用了 table/svg
                setStatus('下載失敗：找不到 QR 碼圖像元素。', 'text-red-500 bg-red-100');
            }
        }

        // 頁面載入時不需要自動生成，但需要確保初始狀態是正確的
        // window.onload = function() {
        //     // 確保初始狀態是圖片和提示文字
        // };

    </script>
</body>
</html>
