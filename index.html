<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客製化 QR Code 生成器</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 qrcode.js 庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* 設定字體 */
        body { font-family: 'Inter', sans-serif; }
        /* QR Code 容器居中 */
        #qrcode {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
            border-radius: 0.5rem;
            background-color: #ffffff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* 隱藏 qrcode.js 預設生成的 canvas 或 table，以便我們操作 */
        #qrcode > canvas, #qrcode > table {
            display: none;
        }
        /* 確保生成的最終 canvas 居中且可見 */
        #qrCanvas {
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">

    <div class="max-w-xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl space-y-6">
        <h1 class="text-3xl font-extrabold text-gray-900 text-center">客製化 QR Code 生成系統</h1>
        <p class="text-center text-gray-500">輸入內容，並將您的圖片 (<span class="font-semibold">Blue.jpg</span>) 嵌入為中心 Logo。</p>

        <!-- 輸入區域 -->
        <div class="space-y-4">
            <label for="qrContent" class="block text-sm font-medium text-gray-700">QR Code 內容 (網址或文字)</label>
            <input type="text" id="qrContent" placeholder="例如：https://www.google.com 或 您的訊息" value="https://www.gemini.google.com"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
            
            <button id="generateBtn"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50">
                生成帶 Logo 的 QR Code
            </button>
        </div>

        <!-- QR Code 顯示區域 -->
        <div id="qrcodeContainer" class="mt-8 pt-6 border-t border-gray-200">
            <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">生成的 QR Code (含 Logo)</h2>
            <div id="qrcode" class="mx-auto w-64 h-64 bg-gray-200 rounded-xl flex items-center justify-center">
                <!-- 最終的帶 Logo QR Code 將繪製到這裡的 canvas 上 -->
                <canvas id="qrCanvas" width="256" height="256" class="hidden"></canvas>
            </div>
            <p id="statusMessage" class="text-center text-sm mt-4 text-red-500 hidden">
                <!-- 錯誤或狀態訊息 -->
            </p>
        </div>

    </div>

    <script>
        // 設定圖片路徑，這是您上傳的 Blue.jpg 的檔案 ID
        const LOGO_IMAGE_SRC = "uploaded:Blue.jpg-5c49ecb3-551e-4f74-8c9b-1c14d3c7ad8c";
        const QR_CODE_SIZE = 256; // 像素寬度/高度
        const LOGO_SIZE_RATIO = 0.25; // Logo 佔 QR Code 尺寸的比例 (25%)
        const LOGO_SIZE = QR_CODE_SIZE * LOGO_SIZE_RATIO;
        const LOGO_X = (QR_CODE_SIZE - LOGO_SIZE) / 2;
        const LOGO_Y = (QR_CODE_SIZE - LOGO_SIZE) / 2;

        let qrCodeInstance = null; // 儲存 qrcode.js 實例

        // 獲取 DOM 元素
        const qrContentInput = document.getElementById('qrContent');
        const generateBtn = document.getElementById('generateBtn');
        const qrcodeContainer = document.getElementById('qrcode');
        const statusMessage = document.getElementById('statusMessage');
        const qrCanvas = document.getElementById('qrCanvas');
        const ctx = qrCanvas.getContext('2d');
        
        // 載入 Logo 圖片
        const logoImg = new Image();
        logoImg.crossOrigin = "anonymous"; // 必須設定 crossOrigin 才能在 canvas 上繪圖
        logoImg.src = LOGO_IMAGE_SRC;
        let isLogoLoaded = false;
        
        logoImg.onload = () => {
            isLogoLoaded = true;
            statusMessage.classList.add('hidden');
            // 如果頁面初始時圖片就載入完成，可以自動生成一次
            if (qrContentInput.value) {
                generateQrWithLogo();
            }
        };

        logoImg.onerror = () => {
            isLogoLoaded = false;
            statusMessage.textContent = '錯誤：Logo 圖片載入失敗，將只生成普通 QR Code。';
            statusMessage.classList.remove('hidden');
        };

        /**
         * 處理生成 QR Code 的主要邏輯
         */
        function generateQrWithLogo() {
            const content = qrContentInput.value.trim();
            if (!content) {
                statusMessage.textContent = '請輸入 QR Code 內容。';
                statusMessage.classList.remove('hidden');
                return;
            }

            statusMessage.classList.add('hidden');
            generateBtn.textContent = '正在生成...';
            generateBtn.disabled = true;

            // 1. 清理舊的 QR Code 顯示
            // 由於 qrcode.js 會創建一個新的 canvas 或 table，我們需要清理容器
            // 這裡我們使用一個臨時的 div 來讓 qrcode.js 在後台生成
            const tempDiv = document.createElement('div');
            tempDiv.style.display = 'none';
            qrcodeContainer.appendChild(tempDiv);
            qrCanvas.classList.add('hidden'); // 暫時隱藏最終 canvas

            // 2. 使用 qrcode.js 生成基本的 QR Code
            try {
                if (qrCodeInstance) {
                    qrCodeInstance.clear(); // 清理舊實例
                }
                
                qrCodeInstance = new QRCode(tempDiv, {
                    text: content,
                    width: QR_CODE_SIZE,
                    height: QR_CODE_SIZE,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H // 使用高錯誤修正等級以容納 Logo
                });

                // qrcode.js 是異步的，使用 setTimeout 等待它完成繪製
                setTimeout(() => {
                    // 3. 獲取 qrcode.js 生成的 Canvas 元素
                    const baseCanvas = tempDiv.querySelector('canvas');
                    if (!baseCanvas) {
                        statusMessage.textContent = 'QR Code 基礎圖形生成失敗。';
                        statusMessage.classList.remove('hidden');
                        cleanup();
                        return;
                    }

                    // 4. 將基礎 QR Code 繪製到我們自己的最終 Canvas 上
                    ctx.clearRect(0, 0, QR_CODE_SIZE, QR_CODE_SIZE);
                    ctx.drawImage(baseCanvas, 0, 0, QR_CODE_SIZE, QR_CODE_SIZE);

                    // 5. 繪製 Logo 圖片
                    if (isLogoLoaded) {
                        // 繪製白色圓形背景以提高 Logo 可讀性 (可選)
                        ctx.beginPath();
                        ctx.arc(
                            QR_CODE_SIZE / 2, // 圓心 X
                            QR_CODE_SIZE / 2, // 圓心 Y
                            LOGO_SIZE / 2 + 5, // 半徑 (比 Logo 稍大)
                            0, 
                            2 * Math.PI
                        );
                        ctx.fillStyle = 'white';
                        ctx.fill();

                        // 繪製 Logo 圖片
                        ctx.drawImage(logoImg, LOGO_X, LOGO_Y, LOGO_SIZE, LOGO_SIZE);
                    } else {
                        statusMessage.textContent = 'Logo 圖片未載入，已生成無 Logo 的普通 QR Code。';
                        statusMessage.classList.remove('hidden');
                    }

                    // 6. 顯示最終的 Canvas 並清理臨時元素
                    qrCanvas.classList.remove('hidden');
                    cleanup();

                }, 500); // 延遲 500ms 確保 qrcode.js 完成繪圖

            } catch (e) {
                statusMessage.textContent = `生成過程中發生錯誤: ${e.message}`;
                statusMessage.classList.remove('hidden');
                cleanup();
            }

            function cleanup() {
                // 清除臨時的 div 
                if (tempDiv.parentNode === qrcodeContainer) {
                    qrcodeContainer.removeChild(tempDiv);
                }
                generateBtn.textContent = '生成帶 Logo 的 QR Code';
                generateBtn.disabled = false;
            }
        }

        // 綁定事件監聽器
        generateBtn.addEventListener('click', generateQrWithLogo);

        // 初始化時，如果 Logo 已經載入，則自動生成一次
        document.addEventListener('DOMContentLoaded', () => {
            if (isLogoLoaded && qrContentInput.value) {
                // 延遲執行確保所有元素都已渲染
                setTimeout(generateQrWithLogo, 100); 
            } else if (!isLogoLoaded) {
                 statusMessage.textContent = 'Logo 圖片仍在載入中，請稍候。';
                 statusMessage.classList.remove('hidden');
            }
        });

    </script>

</body>
</html>
